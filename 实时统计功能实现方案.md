# WhatsApp 群用户实时统计功能实现方案

## 📋 需求概述

实现机器人所有群的实时状态统计，包括：

1. **机器人加入新群** - 自动在后台新增群信息
2. **机器人被移除出群** - 标注群为已退出状态（不删除，需手动删除）
3. **群内新进用户** - 自动录入数据库
4. **群内退出用户** - 自动录入数据库
5. **群内用户被移除** - 自动录入数据库

在群组管理页面显示以下统计字段：
- 原有人数（机器人进群时记录）
- 新进群人数（机器人进群后进入的用户，实时更新）
- 退出人数（实时更新）
- 被移除的用户（实时更新）
- 已进群数量（批次比对，如果绑定了批次，实时更新）
- 未进群数量（批次比对，如果绑定了批次，实时更新）
- 群里多出（批次比对，如果绑定了批次，实时更新）

**说明：** 号码比对功能已整合到群组功能板块中，不再需要单独的比对页面。

---

## 🎯 技术方案

### 整体架构

```
Node.js 服务 (Baileys)
    ↓
监听 WhatsApp 事件
    ├── groups.update (群组变化)
    └── group-participants.update (成员变化)
    ↓
实时推送到 Laravel API
    ↓
Laravel 后端处理
    ├── 自动创建/更新群信息
    ├── 自动记录用户变化
    └── 更新统计字段
    ↓
数据库持久化
    ↓
群组管理页面实时显示
```

---

## 📊 数据库设计变更

### 1. `groups` 表扩展

**新增字段：**
- `status` - `enum('active', 'removed')` - 群状态（活跃/已退出）
- `initial_member_count` - `integer` - 机器人进群时的原有人数
- `bot_joined_at` - `timestamp` - 机器人加入群的时间

**说明：**
- `status = 'active'` 表示机器人仍在群中
- `status = 'removed'` 表示机器人已被移除，但记录保留
- `initial_member_count` 用于计算"原有人数"
- `bot_joined_at` 用于区分"原有人数"和"新进群人数"

### 2. `group_whatsapp_user` 表扩展

**新增字段：**
- `removed_by_admin` - `boolean` - 是否被管理员移除
- `removed_at` - `timestamp` - 被移除的时间（如果被移除）

**说明：**
- `removed_by_admin = true` 表示被管理员移除
- `removed_by_admin = false` 且 `left_at IS NOT NULL` 表示主动退出
- 用于区分"退出人数"和"被移除的用户"

### 3. `group_events` 表扩展

**新增事件类型：**
- `bot_joined_group` - 机器人加入群
- `bot_left_group` - 机器人退出群
- `member_removed` - 用户被管理员移除（区别于 `member_left`）

**说明：**
- `member_joined` - 用户主动加入
- `member_left` - 用户主动退出
- `member_removed` - 用户被管理员移除

---

## 🤖 Node.js 服务改造

### 1. 监听 `groups.update` 事件

**功能：**
- 检测机器人加入新群
- 检测机器人被移除出群

**处理逻辑：**
- **加入新群：**
  - 获取群元数据（群名、成员列表等）
  - 记录当前成员数作为 `initial_member_count`
  - 调用 Laravel API 创建或更新群记录
  - **重要：** 如果群记录已存在（可能是之前退出后重新加入），需要：
    - 更新群状态为 `active`
    - 重新记录 `initial_member_count`（使用当前成员数）
    - 更新 `bot_joined_at` 为当前时间
  - 记录 `bot_joined_group` 事件

- **被移除出群：**
  - 调用 Laravel API 更新群状态为 `removed`
  - 记录 `bot_left_group` 事件

### 2. 监听 `group-participants.update` 事件

**功能：**
- 检测群成员变化（加入/退出/被移除）

**处理逻辑：**
- **成员加入：**
  - 判断加入时间是否在 `bot_joined_at` 之后
  - 调用 Laravel API 记录用户加入
  - 记录 `member_joined` 事件

- **成员退出：**
  - 判断退出原因：
    - 如果有 `author` 字段且不是用户本人 → 被管理员移除
    - 否则 → 主动退出
  - 调用 Laravel API 更新用户状态
  - 记录相应事件（`member_left` 或 `member_removed`）

### 3. 新增 API 接口调用

**需要新增的 Laravel API 接口：**
- `POST /api/bots/{id}/group-joined` - 机器人加入新群
- `POST /api/bots/{id}/group-left` - 机器人退出群
- `POST /api/bots/{id}/member-removed` - 用户被管理员移除

---

## 🎨 Laravel 后端改造

### 1. 数据库迁移

**创建迁移文件：**
- 扩展 `groups` 表（添加 `status`, `initial_member_count`, `bot_joined_at`）
- 扩展 `group_whatsapp_user` 表（添加 `removed_by_admin`, `removed_at`）
- 扩展 `group_events` 表的事件类型枚举

### 2. 模型扩展

**Group 模型：**
- 添加 `status` 和 `initial_member_count` 到 `$fillable`
- 添加状态常量和方法（`isActive()`, `isRemoved()`）
- 添加作用域（`scopeActive()`, `scopeRemoved()`）

**GroupEvent 模型：**
- 添加新的事件类型常量
- 更新 `getEventTypeOptions()` 方法

**GroupWhatsappUser 关系：**
- 添加 `removed_by_admin` 和 `removed_at` 到 `withPivot()`

### 3. API 接口实现

**新增接口：**

1. **`POST /api/bots/{id}/group-joined`**
   - 接收群信息（groupId, name, memberCount 等）
   - **判断群记录是否存在：**
     - **如果不存在：** 创建新群记录
       - 设置 `status = 'active'`
       - 记录 `initial_member_count = memberCount`
       - 记录 `bot_joined_at = now()`
     - **如果已存在：** 更新群记录（重新加入的情况）
       - 更新 `status = 'active'`（如果之前是 `removed`）
       - **重新记录 `initial_member_count = memberCount`**（重要：重新统计原有人数）
       - 更新 `bot_joined_at = now()`（更新加入时间）
       - 注意：之前的统计数据保留，但以新的 `bot_joined_at` 为基准重新计算
   - 创建 `bot_joined_group` 事件

2. **`POST /api/bots/{id}/group-left`**
   - 接收群ID
   - 更新群状态为 `removed`
   - 创建 `bot_left_group` 事件

3. **`POST /api/bots/{id}/member-removed`**
   - 接收群ID和用户信息
   - 更新 `group_whatsapp_user` 记录
   - 设置 `removed_by_admin = true` 和 `removed_at`
   - 创建 `member_removed` 事件

**修改现有接口：**

- **`POST /api/bots/{id}/sync-group-user`**
  - 判断用户加入时间是否在 `bot_joined_at` 之后
  - 如果是，标记为"新进群用户"

- **`POST /api/bots/{id}/sync-group-user-phone`**
  - 同上，判断是否为新进群用户

### 4. 统计服务

**创建或扩展统计服务：**

- **原有人数：** `groups.initial_member_count`
- **新进群人数：** 统计 `joined_at > groups.bot_joined_at` 的用户
- **当前人数：** 统计 `left_at IS NULL` 的活跃用户数
- **退出人数：** 统计 `left_at IS NOT NULL` 且 `removed_by_admin = false` 的用户
- **被移除的用户：** 统计 `removed_by_admin = true` 的用户
- **已进群数量（批次比对）：** 如果绑定了批次，统计批次中的手机号在群里的数量
- **未进群数量（批次比对）：** 如果绑定了批次，统计批次中的手机号不在群里的数量
- **群里多出（批次比对）：** 如果绑定了批次，统计群里的手机号不在批次中的数量
- **匹配率：** 如果绑定了批次，计算 `批次中已进群数量 / 批次总数量 * 100%`

**Group 模型扩展方法：**
- `getOriginalMemberCount()` - 获取原有人数
- `getNewJoinedMemberCount()` - 获取新进群人数
- `getCurrentMemberCount()` - 获取当前人数（活跃用户数）
- `getLeftMemberCount()` - 获取退出人数
- `getRemovedMemberCount()` - 获取被移除的用户数
- `getBatchMatchedCount()` - 获取批次中已进群的数量（如果绑定了批次）
- `getBatchUnmatchedCount()` - 获取批次中未进群的数量（如果绑定了批次）
- `getBatchExtraCount()` - 获取群里多出的数量（如果绑定了批次）
- `getMatchRate()` - 获取匹配率（如果绑定了批次）

**Group 模型扩展方法（用于导出）：**
- `exportUsersToCsv()` - 导出所有用户明细到CSV
  - 返回包含所有用户的CSV字符串
  - 每个用户包含所有分类标识列
  - 支持批次比对标识（如果绑定了批次）

---

## 🖥️ 前端页面改造

### 群组管理页面（Group）改造

**列表页面（ListGroups）：**
- **保留原有字段：**
  - 所属机器人（Bot）- 显示机器人名称
  - 群名称（Group Name）- 可搜索
  - 群 ID（Group ID）- 可复制
  - 绑定批次（Bound Batch）- 显示批次名称（如果有）
  - 最后同步（Last Sync）- 显示最后同步时间
  - 描述（Description）- 群描述信息

- **替换和新增字段：**
  - **删除：** 成员数量（Member Count）
  - **新增：** 群状态（Status）- 活跃/已退出，带状态徽章
  - **新增：** 当前人数（Current Members）- 当前活跃用户数（替代原"成员数量"）
  - **新增：** 原有人数（Original Members）- 机器人进群时的成员数
  - **新增：** 新进群人数（New Joined）- 机器人进群后加入的用户数
  - **新增：** 退出人数（Left Members）- 主动退出的用户数
  - **新增：** 被移除用户（Removed Members）- 被管理员移除的用户数
  - **新增（如果绑定了批次）：** 已进群数量（Matched）- 批次中已进群的号码数量
  - **新增（如果绑定了批次）：** 未进群数量（Unmatched）- 批次中未进群的号码数量
  - **新增（如果绑定了批次）：** 群里多出（Extra）- 群里多出的号码数量（不在批次中）
  - **新增（如果绑定了批次）：** 匹配率（Match Rate）- 批次中已进群数量 / 批次总数量

- **筛选功能：**
  - 按状态筛选（活跃/已退出）
  - 按是否绑定批次筛选
  - 按所属机器人筛选（保留原有）

**详情页面（ViewGroup）：**
- **基本信息区域：**
  - 所属机器人
  - 群名称
  - 群 ID
  - 群状态（活跃/已退出）
  - 绑定批次（如果有）
  - 最后同步时间
  - 描述

- **统计信息卡片：**
  - **基础统计：**
    - 原有人数（机器人进群时的成员数）
    - 新进群人数（机器人进群后加入的用户数）
    - 当前人数（当前活跃用户数）
    - 退出人数（主动退出的用户数）
    - 被移除的用户（被管理员移除的用户数）
  
  - **批次比对统计（如果绑定了批次）：**
    - 已进群数量（批次中已进群的号码数量）
    - 未进群数量（批次中未进群的号码数量）
    - 群里多出（群里多出的号码数量，不在批次中）
    - 匹配率（批次中已进群数量 / 批次总数量 * 100%）

- **用户列表（按类型分类显示）：**
  - **基础分类：**
    - 原有人（机器人进群时就在的用户）
    - 新进群用户（机器人进群后加入的用户）
    - 已退出用户（主动退出的用户）
    - 被移除用户（被管理员移除的用户）
  
  - **批次比对分类（如果绑定了批次）：**
    - 已进群用户（批次中已进群的用户）
    - 未进群用户（批次中未进群的用户）
    - 群里多出用户（群里多出的用户，不在批次中）
  
  - 支持按类型筛选和搜索
  - 每个分类显示用户数量

- **导出功能：**
  - **导出用户明细CSV：**
    - 导出一个包含所有用户的CSV文件
    - CSV列包含：
      - 基本信息列：手机号、WhatsApp用户ID、昵称、头像URL、加入时间、退出时间、是否管理员
      - **基础分类标识列：**
        - 是否原有人（是/否）
        - 是否新进群（是/否）
        - 是否已退出（是/否）
        - 是否被移除（是/否）
        - 用户状态（原有人/新进群/已退出/被移除）
      - **批次比对分类标识列（如果绑定了批次）：**
        - 是否已进群（是/否）- 批次中已进群
        - 是否未进群（是/否）- 批次中未进群
        - 是否群里多出（是/否）- 群里多出，不在批次中
        - 比对状态（已进群/未进群/群里多出/不在批次中）
    - 用户可以在Excel中通过筛选列来查看不同分类的用户明细
    - 文件名格式：`群组_群名称_用户明细_YYYYMMDD_HHmmss.csv`
  
  - **导出统计报表（可选）：**
    - 导出统计汇总报表（Excel格式，包含所有统计字段的汇总数据）
    - 文件名格式：`群组_群名称_统计报表_YYYYMMDD_HHmmss.xlsx`

- **批次绑定功能：**
  - 显示当前绑定的批次（如果有）
  - 可以绑定/解绑手机号批次
  - 绑定后自动显示批次比对结果并实时更新

---

## 🔄 实现步骤

### 第一阶段：数据库扩展
1. 创建数据库迁移文件
2. 扩展模型类（添加字段和关系）
3. 执行迁移

### 第二阶段：Node.js 服务改造
1. 增强 `groups.update` 事件监听
2. 增强 `group-participants.update` 事件监听
3. 实现事件判断逻辑（区分退出和被移除）
4. 添加新的 API 调用方法

### 第三阶段：Laravel API 扩展
1. 实现 `group-joined` 接口
2. 实现 `group-left` 接口
3. 实现 `member-removed` 接口
4. 修改现有同步接口

### 第四阶段：统计功能实现
1. 创建统计服务或方法
2. 实现各统计字段的计算逻辑
3. 优化查询性能（考虑缓存）

### 第五阶段：前端页面改造
1. 修改群组管理页面列表：
   - 整合原有字段和新统计字段
   - 删除"成员数量"，替换为"当前人数"
   - 添加所有统计列（状态、原有人数、新进群人数、退出人数、被移除用户等）
   - 添加批次比对列（已进群数量、未进群数量、群里多出、匹配率）
   - 添加筛选功能
2. 修改群组管理页面详情：
   - 添加基本信息区域
   - 添加统计信息卡片（基础统计 + 批次比对统计）
   - 添加用户分类列表（基础分类 + 批次比对分类）
   - 实现按分类筛选和搜索
3. 实现导出功能：
   - 实现导出用户明细CSV（包含所有用户和分类标识列）
   - 实现统计报表导出（可选，Excel格式）
   - CSV中包含基础分类标识列和批次比对分类标识列（如果绑定了批次）
4. 实现批次绑定功能（如果尚未实现）

### 第六阶段：测试和优化
1. 测试实时事件监听
2. 测试统计准确性
3. 性能优化
4. 错误处理完善

---

## ⚠️ 注意事项

### 1. 事件判断逻辑

**区分"退出"和"被移除"：**
- Baileys 的 `group-participants.update` 事件中，`action: 'remove'` 可能包含两种情况
- 通过事件数据中的 `author` 字段判断：
  - 如果有 `author` 且 `author !== participant` → 被管理员移除
  - 否则 → 主动退出

### 2. 原有人数的记录时机

- 机器人首次加入群时，立即记录当前群成员数
- 如果机器人已经在群中（通过同步群组功能），需要特殊处理：
  - 如果群记录已存在但没有 `initial_member_count`，则使用当前成员数作为初始值
  - 或者提供一个"标记为初始状态"的功能

### 3. 机器人重新加入群的处理

**重要逻辑：**
- 当机器人退出或被移除后，群状态变为 `removed`
- 如果机器人再次被邀请进同一个群，需要：
  - **更新群状态为 `active`**
  - **重新记录 `initial_member_count`**（使用当前群成员数）
  - **更新 `bot_joined_at`** 为当前时间
  - 保留历史数据（之前的用户记录、事件记录等）
  - 以新的 `bot_joined_at` 为基准重新计算统计：
    - "原有人数" = 新的 `initial_member_count`
    - "新进群人数" = `joined_at > 新的 bot_joined_at` 的用户
    - 之前的统计历史保留，但当前统计以新加入时间为准

### 4. 性能考虑

- 统计查询可能涉及大量数据，考虑：
  - 使用数据库索引优化
  - 对频繁查询的统计结果进行缓存
  - 使用 Laravel 的查询优化技巧

### 5. 数据一致性

- 确保事件处理的原子性
- 处理网络异常情况（重试机制）
- 记录处理失败的日志，便于排查

### 6. 向后兼容

- 对于已存在的群记录，需要处理：
  - `status` 字段默认为 `active`
  - `initial_member_count` 如果为空，可能需要特殊处理
  - 历史数据中的 `removed_by_admin` 字段默认为 `false`

---

## 📝 总结

本方案通过扩展数据库结构、增强 Node.js 事件监听、扩展 Laravel API 接口、改造群组管理页面，实现完整的实时统计功能。

**核心思路：**
1. 在数据库层面记录足够的信息（状态、时间、原因等）
2. 通过事件监听实时捕获变化
3. 通过 API 接口实时更新数据
4. 在群组管理页面实时展示统计结果
5. 将号码比对功能整合到群组功能中，简化操作流程

**关键点：**
- 准确区分"退出"和"被移除"
- 准确记录"原有人数"
- 处理机器人重新加入群的情况（重新统计原有人数）
- 实时更新统计字段
- 保证数据一致性
- 在群组页面直接显示所有统计信息和比对结果，无需单独的比对页面

---

**文档版本：** v1.3  
**创建时间：** 2025-01-XX  
**最后更新：** 2025-01-XX  
**更新内容：** 
- v1.1: 添加机器人重新加入群的处理逻辑
- v1.2: 将号码比对功能整合到群组功能板块，移除独立的比对页面
- v1.3: 整合原有群组字段和新统计字段，添加批次比对字段和分类导出功能

